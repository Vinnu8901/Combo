<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Offline XPath Locator & POM + API Studio</title>
<style>
  :root{
    --bg:#0f1217; --panel:#151a21; --panel2:#171e27; --chip:#202734;
    --txt:#e9eef5; --dim:#9db0c5; --brd:#273243;
    --accent:#7c5cff; --ok:#19c37d; --warn:#ffbf47; --bad:#ff4d4f;
    --ed-bg:#fbfcfe; --ed-brd:#dfe6ee; --ed-txt:#0f172a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
  .app{display:grid;grid-template-columns:280px 1fr;height:100%}
  /* Sidebar */
  .side{background:linear-gradient(180deg,#0f1217 0,#0f1217 60%,#0b0e13 100%);border-right:1px solid var(--brd);padding:18px 16px;overflow:auto}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;margin-bottom:14px}
  .beacon{width:10px;height:10px;border-radius:50%;background:linear-gradient(180deg,var(--accent),#563bff);box-shadow:0 0 10px var(--accent)}
  .section{margin:16px 0 8px;color:var(--dim);font-size:12px;letter-spacing:.12em;text-transform:uppercase}
  .btn{width:100%;text-align:left;cursor:pointer;background:var(--panel);border:1px solid var(--brd);border-radius:10px;padding:10px 12px;color:var(--txt);font-weight:600;margin-bottom:8px;transition:.15s}
  .btn:hover{background:var(--panel2);transform:translateY(-1px)}
  .btn.primary{background:linear-gradient(180deg,var(--accent),#6047ff);border-color:#5b49f2}
  .btn.danger{background:linear-gradient(180deg,#ff4d4f,#e13b3e);border-color:#e13b3e}
  .pill{display:flex;gap:8px;align-items:center;background:var(--chip);border:1px solid var(--brd);border-radius:999px;padding:8px 10px;width:max-content;color:var(--dim);font-size:12px}
  .switch{display:flex;gap:8px}
  .switch .sw{padding:8px 12px;border:1px solid var(--brd);border-radius:10px;background:var(--panel);cursor:pointer}
  .sw.active{outline:2px solid rgba(124,92,255,.35)}
  /* Main */
  .main{display:grid;grid-template-rows:auto 1fr auto}
  .toolbar{display:flex;gap:10px;align-items:center;padding:12px 16px;border-bottom:1px solid var(--brd);background:var(--panel);position:sticky;top:0;z-index:5}
  .toolbar .title{font-weight:800}
  .hint{color:var(--dim);font-size:12px;margin-left:auto}
  .mode-chips{display:flex;gap:8px}
  .mode-chip{padding:6px 10px;border-radius:8px;background:#0f1419;border:1px solid var(--brd);cursor:pointer;color:var(--dim);font-weight:700}
  .mode-chip.active{background:linear-gradient(90deg,var(--accent),#5a48f0);color:#fff;box-shadow:0 6px 18px rgba(90,72,240,.12)}
  .workspace{display:grid;grid-template-columns:48% 52%;gap:14px;padding:14px;overflow:auto}
  .card{background:var(--panel);border:1px solid var(--brd);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .card .head{background:var(--panel2);padding:12px 14px;border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:10px;font-weight:700}
  .card .body{padding:12px;display:flex;flex-direction:column;gap:10px;min-height:140px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select,input[type="text"]{background:var(--panel2);border:1px solid var(--brd);border-radius:10px;color:var(--txt);padding:8px 10px}
  textarea.ed{background:var(--ed-bg);border:1px solid var(--ed-brd);border-radius:12px;color:var(--ed-txt);padding:10px;min-height:130px;font-family:ui-monospace,Menlo,Consolas,monospace}
  iframe#preview{width:100%;height:360px;background:#fff;border:none;border-radius:8px}
  .drop{display:flex;justify-content:center;align-items:center;height:56px;border:2px dashed #3a475a;border-radius:12px;color:var(--dim)}
  .chip-tabs{display:flex;gap:8px;flex-wrap:wrap;background:var(--panel);border-bottom:1px solid var(--brd);padding:8px 12px}
  .chip{padding:8px 12px;border:1px solid var(--brd);border-radius:999px;background:#1a2230;color:#b8c6d9;font-size:12px;cursor:pointer}
  .chip.active{color:#fff;border-color:var(--accent);box-shadow:0 0 0 2px rgba(124,92,255,.25) inset}
  .list{display:flex;flex-direction:column;gap:6px;max-height:280px;overflow:auto;background:var(--ed-bg);border:1px solid var(--ed-brd);border-radius:12px;padding:8px}
  .loc-row{background:#fff;border:1px solid #e6ecf5;border-radius:8px;padding:8px 10px;color:#0f172a;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:8px}
  .loc-row:hover{background:#f5f8ff}
  .badge{font-size:11px;background:#eef2ff;border:1px solid #d8e1ff;border-radius:999px;padding:2px 8px;margin-right:8px;color:#1f2b46}
  .footer{display:flex;gap:10px;align-items:center;padding:12px 16px;border-top:1px solid var(--brd);background:var(--panel)}
  .toast{position:fixed;bottom:16px;right:16px;background:#131a24;border:1px solid #2a3648;color:#cfe3ff;padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.15s}
  .toast.show{opacity:1;transform:translateY(0)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .small{font-size:12px;color:var(--dim)}
  .hidden{display:none}
  @media (max-width:980px){.workspace{grid-template-columns:1fr}} 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="side">
    <div class="brand"><span class="beacon"></span> Offline XPath Studio</div>

    <div class="section">Workspace</div>
    <button id="btnPaste" class="btn">Paste HTML</button>
    <button id="btnOpenFile" class="btn">Open .html file</button>
    <div class="pill">Drag & drop file into preview</div>
    <button id="btnClear" class="btn danger">Clear</button>
    <button id="btnExport" class="btn">Export (locators + checks)</button>

    <div class="section">Locator Panels</div>
    <button class="btn" data-panel="basic">Basic</button>
    <button class="btn" data-panel="wildcards">Wildcards</button>
    <button class="btn" data-panel="axes">Axes</button>
    <button class="btn" data-panel="functions">Functions & Relative</button>
    <button class="btn" data-panel="sf">Salesforce / LWC / PEGA</button>
    <!-- NEW: Pega-specific panel button -->
    <button class="btn" data-panel="pega">Pega</button>

    <div class="section">POM & Steps</div>
    <div class="switch">
      <div class="sw active" data-fw="selenium">Selenium</div>
      <div class="sw" data-fw="playwright">Playwright</div>
    </div>
    <div style="height:8px"></div>
    <div class="switch">
      <div class="sw active" data-runner="testng">Maven + TestNG</div>
      <div class="sw" data-runner="cucumber">Maven + Cucumber</div>
    </div>
    <div style="height:8px"></div>
    <div class="switch">
      <div class="sw active" data-lang="java">Java</div>
      <div class="sw" data-lang="javascript">JavaScript</div>
      <div class="sw" data-lang="python">Python</div>
      <div class="sw" data-lang="typescript">TypeScript</div>
    </div>
    <button id="btnGenPOM" class="btn primary" style="margin-top:10px">Generate POM + Steps</button>
    <button id="btnDownloadPOM" class="btn">Download POM file</button>
    <button id="btnDownloadSteps" class="btn">Download Steps file</button>
    <button id="btnZipAll" class="btn">Download ZIP (All)</button>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="toolbar">
      <div class="title">1) Paste/Open HTML → 2) Pick a locator panel → 3) Copy rows → 4) Generate POM + Steps</div>
      <div class="mode-chips">
        <div id="modePOM" class="mode-chip active">POM Studio</div>
        <div id="modeAPI" class="mode-chip">API Studio</div>
      </div>
      <div class="hint">Row click = copy • Priority: name → label → placeholder</div>
    </div>

    <div class="workspace">
     <!-- Left panel for POM Studio -->
<section id="pomLeftCard" class="card">
  <div class="head">Paste HTML</div>
  <div class="body">
    <textarea id="pasteBox" class="ed" placeholder="Paste full page HTML here..."></textarea>
    <div class="row">
      <button id="btnRender" class="btn primary" style="width:auto">Render Preview</button>
      <div class="pill mono">shadow DOM supported at runtime</div>
    </div>
    <div class="head" style="margin:6px -12px 0;border-radius:10px">Preview</div>
    <div class="drop" id="dropZone">Drop .html here</div>
    <iframe id="preview" sandbox="allow-same-origin allow-forms allow-scripts"></iframe>
  </div>
</section>

<!-- Left panel for API Studio -->
<section id="apiLeftCard" class="card hidden">
  <div class="head">Paste cURL</div>
  <div class="body">
    <textarea id="curlBox" class="ed mono" placeholder="Paste cURL here (from Postman/Insomnia)..."></textarea>
    <div class="row" style="align-items:center; gap:12px">
      <label class="small">Framework</label>
      <select id="apiFramework">
        <option value="restassured">RestAssured (Java)</option>
        <option value="karate">Karate DSL</option>
      </select>
      <button id="btnGenAPI" class="btn primary" style="width:auto">Generate API Code</button>
    </div>
  </div>
</section>

      <!-- Right -->
      <section id="rightCard" class="card">
        <div class="head">Locators & Code</div>
        <div class="body" id="rightBody">
          <div id="pomPanel">
            <div class="chip-tabs">
              <div class="chip active" data-paneltab="basic">Basic</div>
              <div class="chip" data-paneltab="wildcards">Wildcards</div>
              <div class="chip" data-paneltab="axes">Axes</div>
              <div class="chip" data-paneltab="functions">Functions</div>
              <div class="chip" data-paneltab="sf">Salesforce</div>
              <!-- NEW: Pega tab -->
              <div class="chip" data-paneltab="pega">Pega</div>
            </div>
            <div id="locList" class="list"></div>

            <div class="head" style="margin:8px -12px 0;border-radius:10px">Output</div>
            <textarea id="output" class="ed mono" placeholder="POM / Steps / Export text will appear here…"></textarea>
          </div>

          <div id="apiPanel" class="hidden">
            <div class="row" style="align-items:flex-end">
              <div style="flex:1">
                <label class="small">Method</label>
                <select id="apiMethod"><option>GET</option><option>POST</option><option>PUT</option><option>DELETE</option></select>
              </div>
              <div style="flex:3">
                <label class="small">Endpoint</label>
                <input id="apiUrl" type="text" placeholder="https://api.example.com/..."/>
              </div>
            </div>

            <div style="display:flex;gap:10px">
              <div style="flex:1">
                <label class="small">Headers (JSON)</label>
                <textarea id="apiHeaders" class="ed" style="min-height:80px">{ "Content-Type":"application/json" }</textarea>
              </div>
              <div style="flex:1">
                <label class="small">Body (JSON)</label>
                <textarea id="apiBody" class="ed" style="min-height:80px">{}</textarea>
              </div>
            </div>

            <div class="row">
              <button id="btnGenerateApi" class="btn primary">Generate Code</button>
              <button id="btnPasteCurl" class="btn">Paste cURL → Parse</button>
              <button id="btnCopyApiCode" class="btn">Copy Code</button>
            </div>

            <div class="head" style="margin:8px -12px 0;border-radius:10px">Generated API Code</div>
            <textarea id="apiCode" class="ed mono" placeholder="RestAssured / Playwright API code will appear here..."></textarea>

            <div class="head" style="margin:8px -12px 0;border-radius:10px">Response / Paste here</div>
            <textarea id="apiResponse" class="ed mono" placeholder="Paste response JSON here to visualize or to include in tests..."></textarea>
          </div>
        </div>
      </section>
    </div>

    <div class="footer">
      <div class="pill">Copy any locator by clicking its row</div>
      <div class="pill">Export includes isVisible / isClickable / isEnabled / isDisabled with waits</div>
    </div>
  </main>
</div>

<input id="hiddenFile" type="file" accept=".html,.htm,.xhtml,.txt" hidden/>
<div id="toast" class="toast">Copied ✔</div>

<script>
/* =========================
   Helpers & State
========================= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const preview = $('#preview');
const locList = $('#locList');
const output = $('#output');
const pasteBox = $('#pasteBox');
const toast = $('#toast');
const hiddenFile = $('#hiddenFile');

let CURRENT_HTML = '';
let CURRENT_DOC = null; // DOM parsed from paste/open
let CURRENT_LOCATORS = []; // [{type,text,xpaths:{basic,wildcards,axes,functions,sf,pega}, playwright, css, id}]
let POM_CACHE = { pom:'', steps:'' };

/* =========================
   UI: Mode switching
========================= */
const modePOM = $('#modePOM');
const modeAPI = $('#modeAPI');
const pomPanel = $('#pomPanel');
const apiPanel = $('#apiPanel');
const leftHead = $('#leftHead');

modePOM.addEventListener('click',()=>setMode('pom'));
modeAPI.addEventListener('click',()=>setMode('api'));
function setMode(m){
  modePOM.classList.remove('active'); 
  modeAPI.classList.remove('active');

  if(m==='pom'){ 
    modePOM.classList.add('active'); 

    // Right side
    pomPanel.classList.remove('hidden'); 
    apiPanel.classList.add('hidden'); 

    // Left side
    $('#pomLeftCard').classList.remove('hidden');
    $('#apiLeftCard').classList.add('hidden');
  }
  else { 
    modeAPI.classList.add('active'); 

    // Right side
    pomPanel.classList.add('hidden'); 
    apiPanel.classList.remove('hidden'); 

    // Left side
    $('#pomLeftCard').classList.add('hidden');
    $('#apiLeftCard').classList.remove('hidden');
  }
}
  

/* =========================
   UI: Sidebar switches
========================= */
$$('.sw').forEach(sw=>{
  sw.addEventListener('click',()=>{
    const groupAttr = [...sw.attributes].find(a=>/^data-/.test(a.name)).name;
    $$(`.sw[${groupAttr}]`).forEach(x=>x.classList.remove('active'));
    sw.classList.add('active');
  });
});

/* =========================
   Toast
========================= */
function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1400); }

/* =========================
   File open / paste / clear
========================= */
$('#btnOpenFile').addEventListener('click', ()=> hiddenFile.click());
hiddenFile.addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload = ev => { pasteBox.value = ev.target.result; renderPreview(); };
  reader.readAsText(f);
});

$('#btnPaste').addEventListener('click', async ()=>{
  try{
    const txt = await navigator.clipboard.readText();
    if(!txt) return showToast('Clipboard empty');
    pasteBox.value = txt;
    renderPreview();
  }catch(e){ showToast('Clipboard permission denied'); }
});

$('#btnClear').addEventListener('click', ()=>{
  pasteBox.value = '';
  preview.srcdoc = '<body style="font-family:sans-serif"><h3>Preview cleared</h3></body>';
  CURRENT_HTML = ''; CURRENT_DOC = null; CURRENT_LOCATORS = []; locList.innerHTML = ''; output.value = '';
});

/* =========================
   Drag & Drop to preview area
========================= */
const dropZone = $('#dropZone');
['dragenter','dragover'].forEach(ev=>dropZone.addEventListener(ev,e=>{ e.preventDefault(); dropZone.style.borderColor='#5a48f0'; }));
['dragleave','drop'].forEach(ev=>dropZone.addEventListener(ev,e=>{ e.preventDefault(); dropZone.style.borderColor='#3a475a'; }));
dropZone.addEventListener('drop', e=>{
  const f=e.dataTransfer.files?.[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload = ev => { pasteBox.value = ev.target.result; renderPreview(); };
  reader.readAsText(f);
});

/* =========================
   Render preview
========================= */
$('#btnRender').addEventListener('click', renderPreview);

function renderPreview(){
  const html = pasteBox.value?.trim() || '<!doctype html><meta charset="utf-8"><body><h3>Paste HTML and click Render</h3></body>';
  CURRENT_HTML = html;
  preview.srcdoc = html;
  // Build parser DOM for extraction
  const parser = new DOMParser();
  CURRENT_DOC = parser.parseFromString(html, 'text/html');
  // Extract locators after render
  setTimeout(extractAllLocators, 50);
  showToast('Preview rendered');
}

/* =========================
   Locator Panels: tab + sidebar sync
========================= */
$('.chip-tabs').addEventListener('click', e=>{
  const chip = e.target.closest('.chip'); if(!chip) return;
  $$('.chip').forEach(c=>c.classList.remove('active')); chip.classList.add('active');
  fillLocatorList(chip.dataset.paneltab || 'basic');
});
$$('.side .btn[data-panel]').forEach(b=>b.addEventListener('click',()=>{
  $$('.chip').forEach(c=>c.classList.remove('active'));
  const sel = b.dataset.panel;
  const chip = $(`.chip[data-paneltab="${sel}"]`);
  if(chip){ chip.classList.add('active'); fillLocatorList(sel); }
  showToast(sel+' panel');
}));

/* =========================
   Locator Extraction Core
========================= */
function textScore(el){
  const t = (el.getAttribute('name')||'') + ' ' +
            (el.getAttribute('aria-label')||'') + ' ' +
            (el.getAttribute('placeholder')||'') + ' ' +
            (el.textContent||'');
  return t.trim().replace(/\s+/g,' ').slice(0,120);
}

  // ====== helpers ======
function downloadText(filename, text){
  const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
}

function slug(s){
  return (s||'element').toString()
    .replace(/\s+/g,'_')
    .replace(/[^A-Za-z0-9_]/g,'')
    .replace(/^(\d)/,'_$1')
    .slice(0,60);
}

function bestXPath(loc){
  if(!loc || !loc.xpaths) return '';
  return loc.xpaths.sfsmart || loc.xpaths.pegasmart || loc.xpaths.sf || loc.xpaths.pega ||
         loc.xpaths.axes || loc.xpaths.functions || loc.xpaths.wildcards || loc.xpaths.basic || '';
}

function uniqNamesFromLocators(locs){
  const used = new Set();
  return locs.map((l,i)=>{
    let base = slug(l.text || l.tag || `elem_${i+1}`);
    if(!base) base = `elem_${i+1}`;
    let name = base, n=2;
    while(used.has(name)){ name = base + '_' + n++; }
    used.add(name);
    return {...l, __name: name};
  });
}
  
  
function bestLabelFor(el){
  // Try: aria-label, label[for], placeholder, innerText
  const aria = el.getAttribute('aria-label');
  if(aria) return aria.trim();
  const id = el.id;
  if(id){
    const lab = CURRENT_DOC.querySelector(`label[for="${cssEscape(id)}"]`);
    if(lab && lab.textContent.trim()) return lab.textContent.trim();
  }
  const ph = el.getAttribute('placeholder'); if(ph) return ph.trim();
  const txt = (el.textContent||'').trim(); if(txt) return txt;
  return '';
}

function cssEscape(s){ return s?.replace(/([#.;,[\]()>+~=:*"\\])/g,'\\$1') || ''; }
// Anchor text used by "smart" XPaths (previous sibling label text, label[for], section heading, aria/placeholder, or own text)
function getSmartAnchorText(el){
  let t = el.previousElementSibling?.textContent?.trim();
  if(t && t.length >= 2) return t.replace(/\s+/g,' ').slice(0,80);

  const id = el.id;
  if(id){
    const lab = CURRENT_DOC.querySelector(`label[for="${cssEscape(id)}"]`);
    if(lab && lab.textContent.trim()) return lab.textContent.trim().replace(/\s+/g,' ').slice(0,80);
  }

  const anc = el.closest?.('fieldset,section,form,div,article');
  if(anc){
    const head = anc.querySelector('legend,h1,h2,h3,h4,h5,h6');
    if(head && head.textContent.trim()) return head.textContent.trim().replace(/\s+/g,' ').slice(0,80);
  }

  const aria = el.getAttribute('aria-label');
  if(aria && aria.trim()) return aria.trim().replace(/\s+/g,' ').slice(0,80);
  const ph = el.getAttribute('placeholder');
  if(ph && ph.trim()) return ph.trim().replace(/\s+/g,' ').slice(0,80);

  const selfTxt = (el.textContent||'').trim();
  if(selfTxt) return selfTxt.replace(/\s+/g,' ').slice(0,80);

  return '';
}
  
function genBasicXPath(el){
  const tag = el.tagName.toLowerCase();
  if(el.id) return `//*[@id="${el.id}"]`;
  if(el.getAttribute('name')) return `//${tag}[@name="${el.getAttribute('name')}"]`;
  const label = bestLabelFor(el);
  if(label) return `//${tag}[contains(normalize-space(.),"${label.replace(/"/g,'\\"')}")]`;
  const cls = (el.getAttribute('class')||'').trim().split(/\s+/).filter(Boolean)[0];
  if(cls) return `//${tag}[contains(@class,"${cls}")]`;
  const parent = el.parentElement;
  if(!parent) return `//${tag}[1]`;
  const same = Array.from(parent.children).filter(x=>x.tagName===el.tagName);
  const idx = same.indexOf(el)+1;
  return `(${genBasicXPath(parent)}/${tag})[${idx}]`;
}

function genWildcardXPath(el){
  const tag=el.tagName.toLowerCase();
  const label = bestLabelFor(el);
  if(label) return `//${tag}[contains(translate(normalize-space(.),"ABCDEFGHIJKLMNOPQRSTUVWXYZ","abcdefghijklmnopqrstuvwxyz"),"${label.toLowerCase().replace(/"/g,'\\"')}")]`;
  const ph = el.getAttribute('placeholder');
  if(ph) return `//${tag}[contains(@placeholder,"${ph.replace(/"/g,'\\"')}")]`;
  const v = (el.value||'').trim();
  if(v) return `//${tag}[contains(@value,"${v.replace(/"/g,'\\"')}")]`;
  return `//${tag}`;
}

function genAxesXPath(el){
  const id = el.id;
  if(id){
    const lab = CURRENT_DOC.querySelector(`label[for="${cssEscape(id)}"]`);
    if(lab){
      const labTxt = lab.textContent.trim().replace(/"/g,'\\"');
      return `//label[normalize-space()="${labTxt}"]//following::${el.tagName.toLowerCase()}[1]`;
    }
  }
  const h = el.closest?.('fieldset,section,div,form');
  if(h && h.querySelector('legend,h1,h2,h3,h4,h5,h6')){
    const head = h.querySelector('legend,h1,h2,h3,h4,h5,h6');
    const t = head.textContent.trim().replace(/"/g,'\\"');
    return `//*[self::legend or self::h1 or self::h2 or self::h3 or self::h4 or self::h5 or self::h6][normalize-space()="${t}"]//following::${el.tagName.toLowerCase()}[1]`;
  }
  const prevTxt = el.previousElementSibling?.textContent?.trim();
  if(prevTxt) return `//*[normalize-space()="${prevTxt.replace(/"/g,'\\"')}"]/following::${el.tagName.toLowerCase()}[1]`;
  return genBasicXPath(el);
}

function genFunctionXPath(el){
  const tag=el.tagName.toLowerCase();
  const label = bestLabelFor(el);
  if(label) return `//${tag}[contains(normalize-space(.),"${label.replace(/"/g,'\\"')}") and not(contains(@disabled,"true"))]`;
  return `//${tag}[normalize-space(@value) or normalize-space(@placeholder)]`;
}

// SALESFORCE — attribute/tag priority: data-qa-locator > data-aura-* > data-key > data-id > lightning-* / force-* > slds-* class
function genSalesforceXPath(el){
  const tag = el.tagName.toLowerCase();
  const cls = el.getAttribute('class') || '';

  if(el.hasAttribute('data-qa-locator'))      return `//*[@data-qa-locator="${el.getAttribute('data-qa-locator')}"]`;
  if(el.hasAttribute('data-aura-class'))      return `//*[@data-aura-class="${el.getAttribute('data-aura-class')}"]`;
  if(el.hasAttribute('data-aura-rendered-by'))return `//*[@data-aura-rendered-by="${el.getAttribute('data-aura-rendered-by')}"]`;
  if(el.hasAttribute('data-key'))             return `//*[@data-key="${el.getAttribute('data-key')}"]`;
  if(el.hasAttribute('data-id'))              return `//*[@data-id="${el.getAttribute('data-id')}"]`;

  if(tag.startsWith('lightning-'))            return `//${tag}`;
  if(tag.startsWith('force-'))                return `//${tag}`;
  if(cls.includes('slds-'))                   return `//*[contains(@class,"slds-")]`;

  // keep your earlier fallbacks
  return genBasicXPath(el);
}

// SALESFORCE — Smart neighbour (anchored to nearby label/heading text) using the same priority
function genSalesforceSmartXPath(el){
  const tag = el.tagName.toLowerCase();
  const anchor = getSmartAnchorText(el);
  if(!anchor) return '';
  const A = anchor.replace(/"/g,'\\"');

  if(el.hasAttribute('data-qa-locator'))       return `//*[normalize-space()="${A}"]//following::*[@data-qa-locator="${el.getAttribute('data-qa-locator')}"][1]`;
  if(el.hasAttribute('data-aura-class'))       return `//*[normalize-space()="${A}"]//following::*[@data-aura-class="${el.getAttribute('data-aura-class')}"][1]`;
  if(el.hasAttribute('data-aura-rendered-by')) return `//*[normalize-space()="${A}"]//following::*[@data-aura-rendered-by="${el.getAttribute('data-aura-rendered-by')}"][1]`;
  if(el.hasAttribute('data-key'))              return `//*[normalize-space()="${A}"]//following::*[@data-key="${el.getAttribute('data-key')}"][1]`;
  if(el.hasAttribute('data-id'))               return `//*[normalize-space()="${A}"]//following::*[@data-id="${el.getAttribute('data-id')}"][1]`;

  if(tag.startsWith('lightning-') || tag.startsWith('force-')) return `//*[normalize-space()="${A}"]//following::${tag}[1]`;

  const cls = el.getAttribute('class') || '';
  if(cls.includes('slds-'))                    return `//*[normalize-space()="${A}"]//following::*[contains(@class,"slds-")][1]`;

  return '';
}

// PEGA — core attribute priority you listed
function genPegaXPath(el){
  const tag = el.tagName.toLowerCase();
  const attrs = [
    'data-test-id','data-ctl','data-click','data-hotkey','data-validation','data-required',
    'data-template','string_type','reserve_space','data-ui-meta','node_name','pyclassname','pyworkpage'
  ];
  for(const a of attrs){
    if(el.hasAttribute(a)) return `//*[@${a}="${el.getAttribute(a)}"]`;
  }
  if(el.getAttribute('role') === 'button') return `//${tag}[@role="button"]`;
  return genBasicXPath(el);
}

// PEGA — Smart neighbour
function genPegaSmartXPath(el){
  const tag = el.tagName.toLowerCase();
  const anchor = getSmartAnchorText(el);
  if(!anchor) return '';
  const A = anchor.replace(/"/g,'\\"');

  const attrs = [
    'data-test-id','data-ctl','data-click','data-hotkey','data-validation','data-required',
    'data-template','string_type','reserve_space','data-ui-meta','node_name','pyclassname','pyworkpage'
  ];
  for(const a of attrs){
    if(el.hasAttribute(a)) return `//*[normalize-space()="${A}"]//following::*[@${a}="${el.getAttribute(a)}"][1]`;
  }
  if(el.getAttribute('role') === 'button') return `//*[normalize-space()="${A}"]//following::${tag}[@role="button"][1]`;
  return '';
}

function genCSS(el){
  const tag = el.tagName.toLowerCase();
  if(el.id) return `#${cssEscape(el.id)}`;
  const name = el.getAttribute('name'); if(name) return `${tag}[name="${name}"]`;
  const cls = (el.getAttribute('class')||'').trim().split(/\s+/).filter(Boolean);
  if(cls.length) return `${tag}.${cls.map(cssEscape).join('.')}`;
  return tag;
}

function genPlaywright(el){
  const tag = el.tagName.toLowerCase();
  const roleable = /^(button|a|input|textarea|select)$/i.test(tag);
  const label = bestLabelFor(el);

  /* NEW: Pega-specific handling */
  if(el.getAttribute('data-ctl') === 'Icon'){
    const cls = el.getAttribute('class') || '';
    if(cls.includes('pi-close-circle')){
      return `page.locator('span[data-ctl="Icon"].pi-close-circle')`;
    }
    return `page.locator('${tag}[data-ctl="Icon"]')`;
  }
  if(el.getAttribute('role') === 'button'){
    return `page.getByRole('button')`;
  }
  if(el.hasAttribute('name')){
    return `page.locator('${tag}[name="${el.getAttribute('name')}"]')`;
  }

  if(roleable && label){
    if(tag==='a') return `page.getByRole("link", { name: "${label}" })`;
    if(tag==='button') return `page.getByRole("button", { name: "${label}" })`;
    if(tag==='input' || tag==='textarea' || tag==='select') return `page.getByLabel("${label}")`;
  }
  if(el.id) return `page.locator("#${el.id}")`;
  const css = genCSS(el);
  return `page.locator("${css}")`;
}

function collectCandidateElements(doc){
  const lwc = ['lightning-input','lightning-button','lightning-combobox','lightning-textarea','lightning-record-edit-form'];
  const basic = Array.from(doc.querySelectorAll('input,button,a,select,textarea,span[role="button"],span[data-ctl]'));
  const lwcEls = lwc.flatMap(tag=>Array.from(doc.getElementsByTagName(tag)));
  const all = [...basic, ...lwcEls];
  return all.filter(el=>{
    const style = (el.getAttribute('style')||'').toLowerCase();
    if(style.includes('display:none') || style.includes('visibility:hidden')) return false;
    return true;
  });
}

// === FULL REPLACE: extractAllLocators ===
function extractAllLocators(){
  if(!CURRENT_DOC){
    if (typeof locList !== 'undefined' && locList) locList.innerHTML = '';
    return;
  }

  const doc = CURRENT_DOC;

  // ---- Collector (uses your collectCandidateElements if present, else a safe fallback)
  let elements = [];
  if (typeof collectCandidateElements === 'function') {
    elements = collectCandidateElements(doc);
  } else {
    // Fallback collector: common interactables + SF/Pega hints
    const basics = Array.from(doc.querySelectorAll(
      'input,button,a,select,textarea,' +            // form + actionable
      'span[role="button"],[role="button"],' +       // role buttons
      '[data-ctl],[data-qa-locator],' +              // Pega/SF hooks
      '[data-aura-class],[data-aura-rendered-by],[data-key],[data-id],' + // SF aura
      '*[class*="slds-"]'                            // SLDS
    ));
    // LWC/force tags (enumerate the common ones)
    const lwc = Array.from(doc.querySelectorAll([
      'lightning-input','lightning-button','lightning-combobox','lightning-textarea',
      'lightning-record-edit-form','lightning-tab','lightning-input-field','lightning-formatted-text'
    ].join(',')));
    const force = Array.from(doc.querySelectorAll([
      'force-record-view','force-input','force-button','force-lookup','force-list-view'
    ].join(',')));

    elements = Array.from(new Set([...basics, ...lwc, ...force]));
  }

  // ---- Map each element to a rich locator object
  CURRENT_LOCATORS = elements.map((el, idx) => {
    const tag = el.tagName.toLowerCase();

    // label/text
    const label =
      (typeof bestLabelFor === 'function' && bestLabelFor(el)) ||
      (typeof textScore === 'function' && textScore(el)) ||
      `elem${idx+1}`;

    // detection (use your helpers if present; otherwise inline heuristics)
    const pegaDetected = (typeof isPegaElement === 'function')
      ? isPegaElement(el)
      : (
          el.hasAttribute('data-test-id') || el.hasAttribute('data-ctl') || el.hasAttribute('data-click') ||
          el.hasAttribute('data-hotkey') || el.hasAttribute('data-validation') || el.hasAttribute('data-required') ||
          el.hasAttribute('data-template') || el.hasAttribute('string_type') || el.hasAttribute('reserve_space') ||
          el.hasAttribute('data-ui-meta') || el.hasAttribute('node_name') || el.hasAttribute('pyclassname') ||
          el.hasAttribute('pyworkpage')
        );

    const sfDetected = (typeof isSalesforceElement === 'function')
      ? isSalesforceElement(el)
      : (
          el.hasAttribute('data-qa-locator') || el.hasAttribute('data-aura-class') || el.hasAttribute('data-aura-rendered-by') ||
          el.hasAttribute('data-key') || el.hasAttribute('data-id') ||
          tag.startsWith('lightning-') || tag.startsWith('force-') || (el.className||'').includes('slds-')
        );

    // XPaths (guard each generator in case you haven’t pasted one)
    const xp_basic     = (typeof genBasicXPath === 'function')      ? genBasicXPath(el)      : '';
    const xp_wildcards = (typeof genWildcardXPath === 'function')   ? genWildcardXPath(el)   : '';
    const xp_axes      = (typeof genAxesXPath === 'function')       ? genAxesXPath(el)       : '';
    const xp_funcs     = (typeof genFunctionXPath === 'function')   ? genFunctionXPath(el)   : '';

    const xp_sf        = (typeof genSalesforceXPath === 'function') ? genSalesforceXPath(el) : '';
    const xp_sfsmart   = (typeof genSalesforceSmartXPath === 'function') ? (genSalesforceSmartXPath(el) || '') : '';

    const xp_pega      = (typeof genPegaXPath === 'function')       ? genPegaXPath(el)       : '';
    const xp_pegasmart = (typeof genPegaSmartXPath === 'function')  ? (genPegaSmartXPath(el) || '') : '';

    // CSS + Playwright
    const cssSel       = (typeof genCSS === 'function')             ? genCSS(el)             : '';
    const pwSel        = (typeof genPlaywright === 'function')      ? genPlaywright(el)      : '';

    // Framework badge (what strategy likely fired)
    const framework = pegaDetected ? 'Pega+' : (sfDetected ? 'Salesforce+' : '');

    return {
      id: `E${idx+1}`,
      tag,
      text: label,
      framework,
      xpaths: {
        basic:     xp_basic,
        wildcards: xp_wildcards,
        axes:      xp_axes,
        functions: xp_funcs,

        // keep both families stored; UI can choose what to show
        sf:        xp_sf,
        sfsmart:   xp_sfsmart,
        pega:      xp_pega,
        pegasmart: xp_pegasmart
      },
      css: cssSel,
      playwright: pwSel
    };
  });

  // ---- Initial fill (choose your default panel; 'basic' is safest)
  if (typeof fillLocatorList === 'function') {
    fillLocatorList('basic');
  } else if (window.fillLocatorList) {
    window.fillLocatorList('basic');
  }
}
// also expose globally (avoids scope issues if other code calls it)
window.extractAllLocators = extractAllLocators;

function fillLocatorList(panel='basic'){
  locList.innerHTML = '';
  if(!CURRENT_LOCATORS.length){ return; }

  CURRENT_LOCATORS.forEach(loc=>{
    // prefer smart when user is on 'sf' or 'pega' panels
    let value = (loc.xpaths?.[panel]) || loc.xpaths.basic;
    if(panel === 'sf'   && loc.xpaths.sfsmart)   value = loc.xpaths.sfsmart   || loc.xpaths.sf;
    if(panel === 'pega' && loc.xpaths.pegasmart) value = loc.xpaths.pegasmart || loc.xpaths.pega;

    const row = document.createElement('div');
    row.className = 'loc-row';
    row.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;min-width:0;flex:1">
        <span class="badge">${(loc.framework||'').trim() || loc.tag}</span>
        <div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:40ch">${loc.text || '(no text)'}</div>
      </div>
      <div class="small mono" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60ch" title="${value}">${value}</div>
    `;
    row.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(value); }catch(e){}
      showToast('Locator copied');
      tryHighlightInPreviewByXPathOrCss({ xpath: value, css: loc.css });
    });
    locList.appendChild(row);
  });
}

/* Existing CSS-only highlight (kept for compatibility) */
function tryHighlightInPreview(loc){
  const css = loc.css;
  try{
    const doc = preview.contentDocument || preview.contentWindow.document;
    if(!doc) return;
    const el = doc.querySelector(css);
    if(!el) return;
    const oldOutline = el.style.outline;
    el.scrollIntoView({behavior:'smooth', block:'center', inline:'center'});
    el.style.outline = '2px solid #7c5cff';
    setTimeout(()=>{ el.style.outline = oldOutline; }, 1000);
  }catch(e){}
}

/* NEW: XPath-aware highlighter helpers */
function highlightElementInIframe(el){
  if(!el) return;
  const oldOutline = el.style.outline;
  el.scrollIntoView({behavior:'smooth', block:'center', inline:'center'});
  el.style.outline = '2px solid #7c5cff';
  setTimeout(()=>{ el.style.outline = oldOutline; }, 1000);
}
function findByXPathInIframe(xpath){
  try{
    const doc = preview.contentDocument || preview.contentWindow.document;
    if(!doc) return null;
    const result = doc.evaluate(xpath, doc, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null);
    const node = result.singleNodeValue;
    return (node && node.nodeType === 1) ? node : null;
  }catch(e){
    return null;
  }
}
function tryHighlightInPreviewByXPathOrCss({xpath, css}){
  const looksXPath = !!xpath && (/^(\(?\/\/|\.\/\/|\/\/|\(\s*\/\/)/.test(xpath));
  if(looksXPath){
    const el = findByXPathInIframe(xpath);
    if(el){ highlightElementInIframe(el); return; }
  }
  try{
    const doc = preview.contentDocument || preview.contentWindow.document;
    if(!doc || !css) return;
    const el = doc.querySelector(css);
    if(el){ highlightElementInIframe(el); }
  }catch(e){}
}

/* =========================
   Export (locators + checks)
========================= *//*
$('#btnExport').addEventListener('click', ()=>{
  if(!CURRENT_LOCATORS.length) return showToast('Nothing to export');
  const lines = [];
  lines.push('// Export — locators with basic checks');
  CURRENT_LOCATORS.forEach(l=>{
    lines.push(`// ${l.tag} — ${l.text}`);
    lines.push(`XPath (basic): ${l.xpaths.basic}`);
    lines.push(`XPath (wildcards): ${l.xpaths.wildcards}`);
    lines.push(`XPath (axes): ${l.xpaths.axes}`);
    lines.push(`XPath (functions): ${l.xpaths.functions}`);
    lines.push(`XPath (salesforce): ${l.xpaths.sf}`);
    lines.push(`XPath (pega): ${l.xpaths.pega}`); // NEW
    lines.push(`CSS: ${l.css}`);
    lines.push(`Playwright: ${l.playwright}`);
    lines.push(`Checks:`)
    lines.push(`  - element should be visible`);
    lines.push(`  - element should be enabled (not disabled)`);
    lines.push(`  - clickable (not covered by overlay)`);
    lines.push('');
  });
  const blob = new Blob([lines.join('\n')], {type:'text/plain'});
  downloadBlob(blob, 'locators_export.txt');
  output.value = lines.join('\n');
  showToast('Exported');
}); */

/* =========================
   Generate POM + Steps
========================= */
$('#btnGenPOM').addEventListener('click', ()=>{
  if(!CURRENT_LOCATORS.length) return showToast('Render & extract first');
  const fw = $('.sw[data-fw].active').dataset.fw;         // selenium | playwright
  const runner = $('.sw[data-runner].active').dataset.runner; // testng | cucumber
  const lang = $('.sw[data-lang].active').dataset.lang;   // java | javascript | python | typescript

  const res = buildArtifacts({fw, runner, lang, locs: CURRENT_LOCATORS});
  POM_CACHE = { pom: res.pom, steps: res.steps };
  output.value = `// ===== POM =====\n${res.pom}\n\n// ===== Steps =====\n${res.steps}`;
  showToast('POM + Steps generated');
});

function buildArtifacts({fw, runner, lang, locs}){
  if(lang==='java'){
    if(fw==='selenium') return javaSeleniumArtifacts(runner, locs);
    return javaPlaywrightArtifacts(runner, locs);
  }
  if(lang==='javascript') return jsPlaywrightArtifacts(locs);
  if(lang==='typescript') return tsPlaywrightArtifacts(locs);
  if(lang==='python') return pyPlaywrightArtifacts(locs);
  return {pom:'// Unsupported combination', steps:''};
}

/* ---------- Java + Selenium ---------- */
function javaSeleniumArtifacts(runner, locs){
  const fields = locs.map((l,i)=>`  @FindBy(xpath = "${l.xpaths.basic}")\n  private WebElement ${camel(l.text)||'elem'+(i+1)};`).join('\n\n');
  const actions = locs.map((l,i)=>`  public void click_${safe(camel(l.text)||('elem'+(i+1)))}(){ ${camel(l.text)||'elem'+(i+1)}.click(); }`).join('\n');
  const waits = `
  private WebDriverWait wait;
  public SamplePage(WebDriver driver){
    this.driver = driver;
    PageFactory.initElements(driver, this);
    this.wait = new WebDriverWait(driver, Duration.ofSeconds(10));
  }
  private void ensureVisible(WebElement e){ wait.until(ExpectedConditions.visibilityOf(e)); }
  private void ensureClickable(WebElement e){ wait.until(ExpectedConditions.elementToBeClickable(e)); }`;

  const pom = `import org.openqa.selenium.*; 
import org.openqa.selenium.support.FindBy;
import org.openqa.selenium.support.PageFactory;
import org.openqa.selenium.support.ui.*;
import java.time.Duration;

public class SamplePage {
  private WebDriver driver;
${fields}

${waits}

${actions}
}
`;

  let steps = '';
  if(runner==='cucumber'){
    steps = `import io.cucumber.java.en.*; 
import org.openqa.selenium.*; 

public class SampleSteps {
  private WebDriver driver;
  private SamplePage page;

  public SampleSteps(){ /* inject your driver here */ }

  @When("user clicks {string}")
  public void userClicks(String name){
    page = new SamplePage(driver);
    page.click_${safe(camel(locs[0]?.text||'elem1'))}();
  }
}
`;
  } else {
    steps = `import org.testng.annotations.*; 
import org.openqa.selenium.*; 

public class SampleTest {
  private WebDriver driver;
  private SamplePage page;

  @BeforeClass
  public void setup(){ /* init driver here */ }

  @Test
  public void example(){
    page = new SamplePage(driver);
    // call actions as needed
  }

  @AfterClass
  public void cleanup(){ if(driver!=null) driver.quit(); }
}
`;
  }
  return {pom, steps};
}

/* ---------- Java + Playwright ---------- */
function javaPlaywrightArtifacts(runner, locs){
  const fields = locs.map((l,i)=>`  private Locator ${camel(l.text)||'elem'+(i+1)};`).join('\n');
  const initLines = locs.map((l,i)=>`    ${camel(l.text)||'elem'+(i+1)} = ${l.playwright};`).join('\n');
  const actions = locs.map((l,i)=>`  public void click_${safe(camel(l.text)||('elem'+(i+1)))}(){ ${camel(l.text)||'elem'+(i+1)}.click(); }`).join('\n');

  const pom = `import com.microsoft.playwright.*;

public class SamplePage {
  private final Page page;
${fields}

  public SamplePage(Page page){
    this.page = page;
${initLines}
  }

${actions}
}
`;
  let steps='';
  if(runner==='cucumber'){
    steps = `import io.cucumber.java.en.*; 
import com.microsoft.playwright.*;

public class SampleSteps {
  private Page page;
  private SamplePage sample;

  public SampleSteps(){ /* inject Playwright Page here */ }

  @When("user clicks {string}")
  public void userClicks(String name){
    sample = new SamplePage(page);
    sample.click_${safe(camel(locs[0]?.text||'elem1'))}();
  }
}
`;
  } else {
    steps = `import org.testng.annotations.*; 
import com.microsoft.playwright.*;

public class SampleTest {
  private Playwright playwright;
  private Browser browser;
  private Page page;

  @BeforeClass
  public void setup(){
    playwright = Playwright.create();
    browser = playwright.chromium().launch();
    page = browser.newPage();
  }

  @Test
  public void example(){
    SamplePage sample = new SamplePage(page);
    // call actions as needed
  }

  @AfterClass
  public void cleanup(){
    if(browser!=null) browser.close();
    if(playwright!=null) playwright.close();
  }
}
`;
  }
  return {pom, steps};
}

/* ---------- JS/TS/Python quick stubs ---------- */
function jsPlaywrightArtifacts(locs){
  const lines = locs.map(l=>`  this.${camel(l.text)||'elem'} = ${l.playwright.replace(/^page\./,'this.page.')};`).join('\n');
  const pom = `class SamplePage {
  constructor(page){
    this.page = page;
${lines}
  }
}
module.exports = { SamplePage };`;
  const steps = `// Use your preferred runner (e.g., @playwright/test) and import SamplePage`;
  return {pom, steps};
}
function tsPlaywrightArtifacts(locs){
  const lines = locs.map(l=>`  ${camel(l.text)||'elem'} = ${l.playwright.replace(/^page\./,'this.page.')};`).join('\n');
  const pom = `export class SamplePage {
  constructor(private page: Page){
${lines}
  }
}`;
  const steps = `// Add your test runner glue (Playwright Test / Cucumber TS)`;
  return {pom, steps};
}
function pyPlaywrightArtifacts(locs){
  const lines = locs.map(l=>`        self.${camel(l.text)||'elem'} = page.locator("${l.css}")`).join('\n');
  const pom = `class SamplePage:
    def __init__(self, page):
        self.page = page
${lines ? lines : '        pass'}
`;
  const steps = `# Add behave/pytest-bdd glue as needed`;
  return {pom, steps};
}

/* =========================
   Download helpers
========================= */
function downloadBlob(blob, filename){
  const a=document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}

$('#btnDownloadPOM').addEventListener('click', ()=>{
  if(!POM_CACHE.pom){ return showToast('Generate POM first'); }
  downloadBlob(new Blob([POM_CACHE.pom],{type:'text/plain'}), 'SamplePage.java');
  showToast('POM downloaded');
});
$('#btnDownloadSteps').addEventListener('click', ()=>{
  if(!POM_CACHE.steps){ return showToast('Generate Steps first'); }
  downloadBlob(new Blob([POM_CACHE.steps],{type:'text/plain'}), 'SampleSteps.java');
  showToast('Steps downloaded');
});

$('#btnZipAll').addEventListener('click', ()=>{
  if(!POM_CACHE.pom || !POM_CACHE.steps || !CURRENT_LOCATORS.length){
    return showToast('Generate POM/Steps & Export locators first');
  }
  const locTxt = CURRENT_LOCATORS.map(l=>[
    `// ${l.tag} — ${l.text}`,
    `XPath: ${l.xpaths.basic}`,
    `CSS: ${l.css}`,
    `Playwright: ${l.playwright}`,
    ''
  ].join('\n')).join('\n');
  downloadBlob(new Blob([POM_CACHE.pom],{type:'text/plain'}), 'SamplePage.java');
  downloadBlob(new Blob([POM_CACHE.steps],{type:'text/plain'}), 'SampleSteps.java');
  downloadBlob(new Blob([locTxt],{type:'text/plain'}), 'Locators.txt');
  showToast('Downloaded 3 files');
});

/* =========================
   API Studio
========================= */
$('#btnPasteCurl').addEventListener('click', async ()=>{
  try{
    const txt = await navigator.clipboard.readText(); if(!txt) return showToast('Clipboard empty');
    parseCurl(txt); showToast('Parsed cURL');
  }catch(e){ showToast('Clipboard blocked'); }
});
$('#btnGenerateApi').addEventListener('click', ()=>{
  generateApiCode(); showToast('API code generated');
});
$('#btnCopyApiCode').addEventListener('click', async ()=>{
  await navigator.clipboard.writeText($('#apiCode').value||'');
  showToast('Code copied');
});
  // NEW: Generate API Code directly from pasted cURL
$('#btnGenAPI').addEventListener('click', ()=>{
  const curl = $('#curlBox').value.trim();
  if(!curl){ showToast('No cURL entered'); return; }
  parseCurl(curl);       // auto-fill method/url/headers/body
  generateApiCode();     // output RestAssured / Karate
  showToast('API code generated');
});

function parseCurl(curl){
  try{
    const method = (curl.match(/-X\s+(GET|POST|PUT|DELETE|PATCH)/i)||[])[1] || 'GET';
    const url = (curl.match(/curl\s+['"]?([^'"\s]+)/i)||[])[1] || '';
    const headerRegex = /-H\s+['"]([^:'"]+)\s*:\s*([^'"]+)['"]/gi;
    const dataMatch = curl.match(/--data(?:-raw)?\s+['"]([^'"]+)['"]/i);
    const headers = {};
    let h; while((h=headerRegex.exec(curl))!==null){ headers[h[1]] = h[2]; }
    $('#apiMethod').value = method.toUpperCase();
    $('#apiUrl').value = url;
    if(Object.keys(headers).length) $('#apiHeaders').value = JSON.stringify(headers, null, 2);
    if(dataMatch) $('#apiBody').value = dataMatch[1];
  }catch(e){ /* no-op */ }
}

function generateApiCode(){
  const method = $('#apiMethod').value;
  const url = $('#apiUrl').value;
  let headers = $('#apiHeaders').value;
  const body = $('#apiBody').value;
  const framework = $('#apiFramework').value; // restassured | karate

  try { headers = JSON.stringify(JSON.parse(headers), null, 2); } catch(e) {}

  let code = "";

  if(framework === "restassured"){
    code = `// RestAssured Example
given()
  .headers(${headers})
  .body(${body})
.when()
  .${method.toLowerCase()}("${url}")
.then()
  .statusCode(200);`;
  }
  else if(framework === "karate"){
    code = `# Karate DSL Example
Feature: API Test
  Scenario: ${method} request
    Given url '${url}'
    And headers ${headers}
    And request ${body}
    When method ${method.toLowerCase()}
    Then status 200`;
  }

  $('#apiCode').value = code;
}

/* =========================
   Utilities
========================= */
function camel(s){
  if(!s) return '';
  return s.toString()
    .replace(/[^\p{L}\p{N}]+/gu,' ')
    .trim()
    .toLowerCase()
    .split(' ')
    .map((w,i)=> i? (w.charAt(0).toUpperCase()+w.slice(1)) : w)
    .join('');
}
function safe(s){ return (s||'').replace(/[^A-Za-z0-9_]/g,''); }

/* Init */
setMode('pom');
</script>
</body>
</html>